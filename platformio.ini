; PlatformIO Project Configuration File
; https://docs.platformio.org/page/projectconf.html

[env]
; Global settings that apply to all environments
monitor_filters = default
monitor_echo = yes

[env:seeed_xiao_esp32s3]
platform = espressif32
board = seeed_xiao_esp32s3
framework = arduino
upload_speed = 921600
monitor_speed = 115200

; Library dependencies
lib_deps = 
	4-20ma/ModbusMaster@^2.0.1
	tzapu/WiFiManager
	me-no-dev/ESPAsyncWebServer
	me-no-dev/AsyncTCP
	bblanchon/ArduinoJson@^6.21.3

; Library finder mode
lib_ldf_mode = chain

; PSRAM configuration for ESP32S3
board_build.arduino.memory_type = qio_opi
board_build.partitions = esp32s3_partitions.csv
board_build.filesystem = littlefs

; Build flags
build_flags =
    ; Include paths
    -I${PROJECT_DIR}/lib/XY-SKxxx
    -I${PROJECT_DIR}/include
    -I${PROJECT_DIR}/src/config
    -I${PROJECT_DIR}/src/web_interface
    -I${PROJECT_DIR}/src/wifi_interface
    -I${PROJECT_DIR}/src/modbus
    ; Hardware configuration
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; Board identification
    -DCONFIG_IDF_TARGET_ESP32S3=1
    ; Feature flags
    -DASYNCWEBSERVER_REGEX=0
    -DUSE_ESP32=1
    -DNO_RP2040=1
    -DNO_ESP8266=1
    ; Optimization
    -Os
    -DCORE_DEBUG_LEVEL=0

[env:seeed_xiao_esp32c3]
platform = espressif32
board = seeed_xiao_esp32c3
framework = arduino
upload_speed = 921600
monitor_speed = 115200

; Minimal library set for ESP32C3 (lighter versions)
lib_deps = 
	4-20ma/ModbusMaster@^2.0.1
	tzapu/WiFiManager@^2.0.16          ; Older, more stable version
	me-no-dev/ESPAsyncWebServer@^1.2.3 ; Lighter version
	me-no-dev/AsyncTCP
	bblanchon/ArduinoJson@^6.21.3

; Library finder mode
lib_ldf_mode = chain

; ESP32C3 configuration (no PSRAM, 4MB flash)
board_build.partitions = esp32c3_partitions.csv
board_build.filesystem = littlefs

; ESP32C3 optimized build flags
build_flags =
    ; Include paths
    -I${PROJECT_DIR}/lib/XY-SKxxx
    -I${PROJECT_DIR}/include
    -I${PROJECT_DIR}/src/config
    -I${PROJECT_DIR}/src/web_interface
    -I${PROJECT_DIR}/src/wifi_interface
    -I${PROJECT_DIR}/src/modbus
    ; Board identification
    -DCONFIG_IDF_TARGET_ESP32C3=1
    -DUSE_ESP32C3=1
    ; Hardware configuration (no PSRAM)
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; Memory optimizations for limited 400KB RAM
    ; NOTE: These intentionally override framework defaults (16) causing harmless warnings
    -DCONFIG_LWIP_MAX_SOCKETS=8        ; Reduce from 16 to 8
    -DCONFIG_LWIP_MAX_ACTIVE_TCP=4     ; Reduce TCP connections
    -DCONFIG_FREERTOS_UNICORE=1        ; Single core optimization
    ; Feature control flags
    -DESP32C3_MINIMAL_BUILD=1          ; Enable minimal build mode
    -DASYNCWEBSERVER_REGEX=0
    -DUSE_ESP32=1
    -DNO_RP2040=1
    -DNO_ESP8266=1
    ; Size optimization
    -Os
    -DCORE_DEBUG_LEVEL=1               ; Some debug for troubleshooting

; Custom scripts for extended functionality
extra_scripts = scripts/tools_script.py

; Custom targets for size and partition inspection
custom_showsize = python "$PROJECT_DIR/scripts/show_size.py"
custom_showpart = python "$PROJECT_DIR/scripts/show_partitions.py"

; Standard PlatformIO tasks are available:
; - pio run                   = build project
; - pio run --target upload   = build and upload firmware
; - pio run --target uploadfs = build and upload filesystem
; - pio run -t custom_showsize    = show detailed firmware size information
; - pio run -t custom_showpart    = show detailed partition information
; - pio run -t uploadpart     = upload only the partition table
; - pio device monitor        = open serial monitor